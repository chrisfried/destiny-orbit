<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Destiny VR Orbit</title>
  <meta name="description" content="Destiny VR Orbit">
  <script src="https://aframe.io/releases/0.6.0/aframe.min.js"></script>
  <script>
    window.DESTINYMODELCONFIG = {
      d1Manifest: 'https://lowlidev.com.au/destiny/api/gearasset/$itemHash',
      d2Manifest: 'https://lowlidev.com.au/destiny/api/gearasset/$itemHash?destiny2'
    }
    switch (window.location.hostname) {
      case 'dev.guardian.theater':
        window.DESTINYMODELCONFIG.apiKey = '4da0bc9d76774c5696ea2703b129a2cd';
        break;
      case 'chrisfried.github.io':
        window.DESTINYMODELCONFIG.apiKey = '83c21174d7ed4292884fed250a383fee';
        break;
      default:
        window.DESTINYMODELCONFIG.apiKey = '';
    }

    AFRAME.registerComponent('center-zero', {
      schema: {
        parent: {
          type: 'selector'
        },
        target: {
          type: 'selector'
        }
      },
      init: function () {
        this.box;
      },
      tick: function () {
        if (this.el.getObject3D('mesh') && !this.box) {
          this.box = new THREE.Box3().setFromObject(this.el.getObject3D('mesh'));
          var scale = 1;
          if (this.box.max.x - this.box.min.x > this.box.max.y - this.box.min.y) {
            scale = scale / (this.box.max.x - this.box.min.x)
          } else {
            scale = scale / (this.box.max.y - this.box.min.y)
          }
          this.el.setAttribute('scale', {
            x: scale,
            y: scale,
            z: scale
          });
          var offset = {
            x: this.data.parent.object3D.position.x - this.box.min.x - (this.box.max.x - this.box.min.x) / 2,
            y: this.data.parent.object3D.position.y - this.box.min.y - (this.box.max.y - this.box.min.y) / 2,
            z: this.data.parent.object3D.position.z - this.box.min.z - (this.box.max.z - this.box.min.z) / 2
          }
          this.el.setAttribute('position', {
            x: offset.x * scale,
            y: offset.y * scale,
            z: offset.z * scale
          });
        }
        if (this.box) {
          var target = this.data.target.object3D.getWorldPosition();
          this.data.parent.setAttribute('position', {
            x: target.x,
            y: target.y,
            z: target.z
          });;
        }
      }
    });
  </script>
  <script src="https://unpkg.com/aframe-destiny-model-component@^1.0.x/dist/aframe-destiny-model-component.min.js" data-angle="aframe-destiny-model-component"></script>
</head>

<body>
  <a-scene inspector>

    <a-entity class="wrap" position="0 0 -.5">
      <a-entity class="destiny-model" center-zero="parent: .wrap; target: .half-meter"></a-entity>
    </a-entity>

    <a-sky height="2048" radius="30" color="#AAAAAA" width="2048"></a-sky>

    <a-entity camera look-controls>
      <a-entity class="half-meter" position="0 0 -.6"></a-entity>
      <a-entity light="intensity: 2; type: spot; target: .half-meter; cast-shadow: true" position=".5 .5  0"></a-entity>
      <a-entity light="intensity: 1; type: point; cast-shadow: true" position="0 0 -1"></a-entity>
    </a-entity>
  </a-scene>

  <script>
    var url_string = window.location.href
    var url = new URL(url_string);
    var game = url.searchParams.get('game') || 'destiny';;
    var itemHash = url.searchParams.get('itemHash') || 1170904292;
    var el = document.querySelector('.destiny-model');
    el.setAttribute('destiny-model', {
      game: game,
      itemHash: itemHash
    });
    console.log(el)
  </script>
</body>

</html>